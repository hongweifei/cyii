<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>歌词滚动</title>

    <style>
        html {
            width: 100%;
            height: 100%;
        }
        body {
            margin: 0;
            background-color: black;
            color: gray;
            text-align: center;

            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .audio {
            width: 50vw;
            margin-top: 3em;
        }

        .container {
            width: 100%;
        }

        .list-lrc {
            list-style: none;

            overflow: auto;
            scroll-behavior: smooth;
            transition: .3s linear;

            padding: 0;
            margin: 0;
            height: 24em;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            gap: 1em;
        }
        .list-lrc::-webkit-scrollbar {
            background-color: #aaa;;
            border-radius: 0.25rem;
        }
        .list-lrc::-webkit-scrollbar-thumb {
            background-color: #666;
            border-radius: 0.25rem;
        }
        .list-lrc::-webkit-scrollbar-button {
            display: none;
        }

        .list-lrc .list-item {
            user-select: none;
            transition: .2s;
        }

        .list-lrc .list-item.active {
            color: white;
            transform: scale(1.25);
        }
    </style>
</head>
<body>
    <div class="container">
        <ul class="list-lrc">
        </ul>
    </div>
    <audio class="audio" src="忘了你忘了我.mp3" controls></audio>

    <script>
        (async function() {
            const response = await fetch("./忘了你忘了我.lrc");
            const lrc = await response.text();
            console.log(lrc);

            const lrcList = lrc.split("\n").map(item => {
                const [timeString, text] = item.split("]");
                const [minute, second] = timeString.slice(1).split(":");
                const time = parseInt(minute) * 60 + parseInt(second);
                return {
                    time,
                    text: text.trim()
                };
            });

            /** @type {HTMLAudioElement} */
            const audioElement = document.querySelector(".audio");
            /** @type {HTMLUListElement} */
            const lrcListElement = document.querySelector(".list-lrc");
            for(const item of lrcList) {
                const li = document.createElement("li");
                li.className = "list-item";
                li.textContent = item.text;
                lrcListElement.appendChild(li);
            }
            const lrcListItemElements = lrcListElement.children;
            let currentIndex = 0;
            audioElement.addEventListener("timeupdate", () => {
                const currentTime = audioElement.currentTime;
                for (let i = 0; i < lrcList.length - 1; i++) {
                    const item1 = lrcList[i];
                    const item2 = lrcList[i + 1];

                    if (item1.time <= currentTime && currentTime < item2.time) {
                        currentIndex = i;
                        break;
                    } else if (currentTime >= item2.time) {
                        currentIndex = i + 1;
                    }
                }
                // 清除 active
                for(let i = 0; i < lrcList.length; i++) {
                    if (i === currentIndex) {
                        continue;
                    }
                    if (lrcListItemElements[i].classList.contains("active")) {
                        lrcListItemElements[i].classList.remove("active");
                    }
                }

                let currentElement = lrcListItemElements[currentIndex];
                if (currentElement.classList.contains("active")) {
                    return;
                }
                currentElement.classList.add("active");

                const listRectangle = lrcListElement.getBoundingClientRect();
                const itemRectangle = currentElement.getBoundingClientRect();
                const offset = itemRectangle.top - listRectangle.top - lrcListElement.clientHeight / 2.5;
                // console.log(offset);
                lrcListElement.scrollBy(0, offset);
            });
        })();
    </script>
</body>
</html>
